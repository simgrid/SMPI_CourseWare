<!DOCTYPE html>
<html lang="en-us">


<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Topic &#35;0 &middot; SMPI CourseWare
    
  </title>



  <!-- Semantic UI, JQuery, etc. -->
  <link rel="stylesheet" type="text/css" href="/SMPI_CourseWare//semantic/semantic.min.css">
  <link rel="stylesheet" type="text/css" href="/SMPI_CourseWare//public/basics.css">
  <link rel="stylesheet" type="text/css" href="/SMPI_CourseWare//public/syntax.css">

  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script> -->
  <script src="/SMPI_CourseWare//jquery/jquery.min.js"></script>
  <script src="/SMPI_CourseWare//semantic/components/accordion.js"></script>
  <script src="/SMPI_CourseWare//semantic/components/popup.js"></script>
  <script src="/SMPI_CourseWare//semantic/components/transition.js"></script>
  <script src="/SMPI_CourseWare//semantic/components/tab.js"></script>

  <script language='javascript'>
               $(document).ready(function(){
               $('.ui.accordion').accordion();
               $('.popable')
                   .popup({
                     position: 'right center'
                   })
               ;
                 $('.menu .item').tab();

                 $('.paths.example .menu .item')
                     .tab({
                       context: '.paths.example'
                     })
                 ;

               });
  </script>


</head>



<body>

	

<div class="ui vertical left fixed menu basic  ">
  <br>
  <a href="http://simgrid.org" target="_blank">
  <img width=99 src="/SMPI_CourseWare/public/simgrid_logo.jpg" style="margin-left:5px">
  </a>
  <br>
  <br>




  <a class="ui item " href="/SMPI_CourseWare/">
    <h3 class="ui header">Home</h3>
  </a>


  
  
  
  
  
  <a class="ui popable item fluid " href="/SMPI_CourseWare//000_objectives/"
       data-content="Curricular information" data-variation="inverted">
      <h3 class="ui header fluid">About
      </h3>
  </a>
  
  
  
  
  
  
  
  <a class="ui popable item fluid  active" href="/SMPI_CourseWare//00_topic/"
       data-content="Getting started with SMPI" data-variation="inverted">
      <h3 class="ui header fluid">Topic &#35;0
      </h3>
  </a>
  
  
  
  
  
  
  
  <a class="ui popable item fluid " href="/SMPI_CourseWare//01_topic/"
       data-content="Basics of distributed memory programming" data-variation="inverted">
      <h3 class="ui header fluid">Topic &#35;1
      </h3>
  </a>
  
  
  
  
  
  
  
  <a class="ui popable item fluid " href="/SMPI_CourseWare//02_topic/"
       data-content="Communication on distributed platforms" data-variation="inverted">
      <h3 class="ui header fluid">Topic &#35;2
      </h3>
  </a>
  
  
  
  
  
  
  
  <a class="ui popable item fluid " href="/SMPI_CourseWare//03_topic/"
       data-content="Rigid distributed memory programs" data-variation="inverted">
      <h3 class="ui header fluid">Topic &#35;3
      </h3>
  </a>
  
  
  
  
  
  
  
  <a class="ui popable item fluid " href="/SMPI_CourseWare//04_topic/"
       data-content="Understanding performance" data-variation="inverted">
      <h3 class="ui header fluid">Topic &#35;4
      </h3>
  </a>
  
  
  
  
  
  
  
  <a class="ui popable item fluid " href="/SMPI_CourseWare//05_topic/"
       data-content="Flexible distributed memory programs" data-variation="inverted">
      <h3 class="ui header fluid">Topic &#35;5
      </h3>
  </a>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <div class="ui divider" style="margin-top:0em"></div>

</div>



	<div class="contentpage container fluid">
	<div class="page">
  <br>
	
	<h1 class="ui header">Topic &#35;0: Getting started with SMPI</h1>
	
  <div class="ui divider"></div>

	
<div class="container ui raised segment">
<h3 class="ui header">Overview</h3>

  <p class="ui">This topic focuses on getting you started with SMPI (Simulated MPI)
  so that you are ready for the modules in the next topics. Simply read through the
  4 tabs below:
  </p>
</div>

<div class="ui pointing secondary menu">
  <a class="item active" data-tab="first">Installing SimGrid</a>
  <a class="item " data-tab="second">Platform XML</a>
  <a class="item" data-tab="third">Hello World</a>
  <a class="item" data-tab="fourth">Limitations</a>
</div>

<div class="ui tab segment active" data-tab="first">
  <p class="ui">
<b>
  This CourseWare was tested with <a href="http://simgrid.gforge.inria.fr/">SimGrid</a>
  version 3.13 (small changes <i>may</i> be needed with other versions).
  </b>
</p>

<p class="ui">
  On a <b>recent Debian/Ubuntu (virtual) machine</b>, you can retrieve SimGrid directly from the
  package manager: <code>sudo apt-get install simgrid</code>
  Do not forget to check that you obtained a sufficiently recent version, e.g., by doing <code>apt-cache show libsimgrid-dev</code>.
  If the version you obtain this way is too old, we recommend you to manually install simgrid and to follow the instructions bellow.
</p>

<hr />
<p class="ui">
  For other systems, please refer to the <a href="http://simgrid.gforge.inria.fr/download.html">Download page</a>
  that have all the information you need. But just to be sure, here is
  a typical way to compile the version you want on a Linux (virtual) box:
</p>

<div class="ui list bulleted">
  <div class="ui item">Install the dependencies: <code>sudo apt-get install g++ libboost-all-dev</code></div>
  <div class="ui item">Download the .tar.gz of the latest stable version from the <a href="http://simgrid.gforge.inria.fr/download.html">Download page</a></div>
  <div class="ui item">Extract the archive: <code>tar -xvf SimGrid-x.x.x.tar.gz</code></div>
  <div class="ui item">Go to the extracted directory: <code>cd SimGrid-x.x.x</code></div>
  <div class="ui item">Generate all makefiles: <code>cmake -DCMAKE_INSTALL_PREFIX=/usr/local -Denable_smpi=on -Denable_documentation=off</code><br /> (Assuming you want to install in <code>/usr/local/</code>)</div>
  <div class="ui item">Build: <code>make</code></div>
  <div class="ui item">Run the tests (for the paranoid): <code>make check</code></div>
  <div class="ui item">Install libraries and executables: <code>sudo make install</code></div>
</div>

<p class="ui">
  Assuming your path includes <code>/usr/local/bin</code> (which it should), you now can invoke two new
  commands: <b><code>smpicc</code></b> and <b><code>smpirun</code></b>.
</p>

<hr />
<p class="ui">
  If you are not a superuser on your system, then you have to install SimGrid in your home directory, say in a directory
  called <code>local</code>, with the modified <code>cmake</code>
  invocation. The binaries are then available as
  <code>~/bin/smpicc</code> and <code>~/bin/smpirun</code>.
</p>

<div class="ui list">
  <div class="ui item"><code>cmake -DCMAKE_INSTALL_PREFIX=$HOME/local/ -Denable_smpi=on -Denable_documentation=off</code></div>
</div>

</div>

<div class="ui tab segment " data-tab="second">
  <p class="ui">
SMPI simulates the execution of MPI applications by relying on the fast and accurate simulation
core provided by <a href="http://simgrid.gforge.inria.fr">SimGrid</a>. The SMPI
  user (you!) must describe simulated platforms (i.e., sets of simulated hosts and network links, with
  some performance characteristics).  The SimGrid documentation provides ample information
  on platform descriptions, which are written in XML.  Below we simply show a series of examples,
  which should be sufficient for our purpose. Note that platform files are typically provided
  in each pedagogic module, but you may have to modify them.
</p>

<div class="ui divider"></div>

<p class="ui">
  <b>A simple 3-host example:</b> At the most basic level, you can describe your simulated platform
  as a graph of hosts and network links. For instance:
</p>

<p style="text-align:center;" class="ui">
  <img align="center" src="../topic_getting_started/3_hosts.jpg" width="240" />
</p>


<div class="ui accordion">
  <div class=" title">
    <i class="dropdown icon"></i>
  See the XML platform description file...
  </div>
  <div class=" content">
    <div class="ui container segment">
    
<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version='1.0'?&gt;</span>
<span class="cp">&lt;!DOCTYPE platform SYSTEM "http://simgrid.gforge.inria.fr/simgrid/simgrid.dtd"&gt;</span>
<span class="nt">&lt;platform</span> <span class="na">version=</span><span class="s">"4.1"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;zone</span> <span class="na">id=</span><span class="s">"AS0"</span> <span class="na">routing=</span><span class="s">"Full"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;host</span> <span class="na">id=</span><span class="s">"host0"</span> <span class="na">speed=</span><span class="s">"1Gf"</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;host</span> <span class="na">id=</span><span class="s">"host1"</span> <span class="na">speed=</span><span class="s">"2Gf"</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;host</span> <span class="na">id=</span><span class="s">"host2"</span> <span class="na">speed=</span><span class="s">"40Gf"</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;link</span> <span class="na">id=</span><span class="s">"link0"</span> <span class="na">bandwidth=</span><span class="s">"125MBps"</span> <span class="na">latency=</span><span class="s">"100us"</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;link</span> <span class="na">id=</span><span class="s">"link1"</span> <span class="na">bandwidth=</span><span class="s">"50MBps"</span> <span class="na">latency=</span><span class="s">"150us"</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;link</span> <span class="na">id=</span><span class="s">"link2"</span> <span class="na">bandwidth=</span><span class="s">"250MBps"</span> <span class="na">latency=</span><span class="s">"50us"</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;route</span> <span class="na">src=</span><span class="s">"host0"</span> <span class="na">dst=</span><span class="s">"host1"</span><span class="nt">&gt;&lt;link_ctn</span> <span class="na">id=</span><span class="s">"link0"</span><span class="nt">/&gt;&lt;link_ctn</span> <span class="na">id=</span><span class="s">"link1"</span><span class="nt">/&gt;&lt;/route&gt;</span>
     <span class="nt">&lt;route</span> <span class="na">src=</span><span class="s">"host1"</span> <span class="na">dst=</span><span class="s">"host2"</span><span class="nt">&gt;&lt;link_ctn</span> <span class="na">id=</span><span class="s">"link1"</span><span class="nt">/&gt;&lt;link_ctn</span> <span class="na">id=</span><span class="s">"link2"</span><span class="nt">/&gt;&lt;/route&gt;</span>
    <span class="nt">&lt;route</span> <span class="na">src=</span><span class="s">"host0"</span> <span class="na">dst=</span><span class="s">"host2"</span><span class="nt">&gt;&lt;link_ctn</span> <span class="na">id=</span><span class="s">"link0"</span><span class="nt">/&gt;&lt;link_ctn</span> <span class="na">id=</span><span class="s">"link2"</span><span class="nt">/&gt;&lt;/route&gt;</span>
  <span class="nt">&lt;/zone&gt;</span>
<span class="nt">&lt;/platform&gt;</span>

    </code></pre></figure>

    </div>
  </div>
</div>

<p class="ui">
  In the above XML, note the way in which hosts, links, and routes are defined. Note that all hosts are defined
  with a <code>power</code> (i.e., compute speed in Gflops), and links with a <code>latency</code> (in us)
  and <code>bandwidth</code> (in Mbit/sec). Other units are possible and written as expected.
  By default, routes are symmetrical. See more information on the
  <a href="http://simgrid.gforge.inria.fr">SimGrid Web site</a>.
</p>

<p class="ui">
  This XML file is intended for SimGrid v3.21 or earlier. To
  use it with more recent versions, you may have to convert it using the
  <code>simgrid_update_xml</code> program, as follows:
</p>
<div class="ui list">
  <div class="ui item"><code>simgrid_update_xml 3_hosts.xml</code></div>
</div>


<div class="ui divider"></div>


<p class="ui">
  <b>A homogeneous cluster with a crossbar switch:</b> A very common parallel computing platform is a homogeneous
  cluster in which hosts are interconnected via a crossbar switch with as many ports as hosts, so that any disjoint
  pairs of hosts can communicate concurrently at full speed. For instance:
</p>

<p style="text-align:center;" class="ui">
  <img align="center" src="../topic_getting_started/cluster_crossbar.jpg" width="470" />
</p>


<div class="ui accordion">
  <div class=" title">
    <i class="dropdown icon"></i>
    See the XML platform description file...
  </div>
  <div class=" content">
    <div class="ui container segment">
    
<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version='1.0'?&gt;</span>
<span class="cp">&lt;!DOCTYPE platform SYSTEM "http://simgrid.gforge.inria.fr/simgrid/simgrid.dtd"&gt;</span>
<span class="nt">&lt;platform</span> <span class="na">version=</span><span class="s">"4.1"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;zone</span> <span class="na">id=</span><span class="s">"AS0"</span> <span class="na">routing=</span><span class="s">"Full"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;cluster</span> <span class="na">id=</span><span class="s">"my_cluster"</span> <span class="na">prefix=</span><span class="s">"host-"</span> <span class="na">suffix=</span><span class="s">".hawaii.edu"</span> <span class="na">radical=</span><span class="s">"0-255"</span> <span class="na">speed=</span><span class="s">"1Gf"</span> <span class="na">bw=</span><span class="s">"125Mbps"</span> <span class="na">lat=</span><span class="s">"5us"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/zone&gt;</span>
<span class="nt">&lt;/platform&gt;</span>

    </code></pre></figure>

    </div>
  </div>
</div>

<p class="ui">
  In the above XML, note that one simply specifies a name prefix and suffix for each host, and then give an integer
  range (in the example the cluster contains 256 hosts). All hosts have the same power (1 Gflop/sec) and are connected to the switch via links with same latency (5 microseconds) and
  bandwidth (125 Mbit/sec). See more information on the
  <a href="http://simgrid.gforge.inria.fr">SimGrid Web site</a>.

</p>

<div class="ui divider"></div>


<p class="ui">
  <b>A homogeneous cluster with a shared backbone:</b> Another popular model for a parallel platform is that of a set of homogeneous
  hosts connected to a shared communication medium, a backbone, with some finite bandwidth capacity and on which communicating host pairs can
  experience contention. For instance:
</p>

<p style="text-align:center;" class="ui">
  <img align="center" src="../topic_getting_started/cluster_backbone.jpg" width="470" />
</p>


<div class="ui accordion">
  <div class=" title">
    <i class="dropdown icon"></i>
    See the XML platform description file...
  </div>
  <div class=" content">
    <div class="ui container segment">
    
<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version='1.0'?&gt;</span>
<span class="cp">&lt;!DOCTYPE platform SYSTEM "http://simgrid.gforge.inria.fr/simgrid/simgrid.dtd"&gt;</span>
<span class="nt">&lt;platform</span> <span class="na">version=</span><span class="s">"4.1"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;zone</span> <span class="na">id=</span><span class="s">"AS0"</span> <span class="na">routing=</span><span class="s">"Full"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;cluster</span> <span class="na">id=</span><span class="s">"my_cluster"</span> <span class="na">prefix=</span><span class="s">"host−"</span> <span class="na">suffix=</span><span class="s">".hawaii.edu"</span> <span class="na">radical=</span><span class="s">"0−255"</span> <span class="na">speed=</span><span class="s">"1Gf"</span> <span class="na">bw=</span><span class="s">"125Mbps"</span> <span class="na">lat=</span><span class="s">"50us"</span> <span class="na">bb_bw=</span><span class="s">"2.25Gbps"</span> <span class="na">bb_lat=</span><span class="s">"500us"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/zone&gt;</span>
<span class="nt">&lt;/platform&gt;</span>

    </code></pre></figure>

    </div>
  </div>
</div>

<p class="ui">
  In the above XML, note that one specifies the latency and bandwidth of the link that connects a host to the backbone (in this
  example 50 microsec and 125 Mbit/sec), as well
  as the latency and bandwidth of the backbone itself (in this example
  500 microsec and 2.25 Gbit/sec). See more information on the
  <a href="http://simgrid.gforge.inria.fr">SimGrid Web site</a>.

</p>

<div class="ui divider"></div>


<p class="ui">
  <b>Two interconnected clusters:</b> One can connect clusters together and in fact build simulated platforms
  hierarchically in arbitrary fashions. For instance:
</p>

<p style="text-align:center;" class="ui">
  <img align="center" src="../topic_getting_started/2_clusters.jpg" width="470" />
</p>


<div class="ui accordion">
  <div class=" title">
    <i class="dropdown icon"></i>
    See the XML platform description file...
  </div>
  <div class=" content">
    <div class="ui container segment">
    
<figure class="highlight"><pre><code class="language-xml" data-lang="xml">    <span class="cp">&lt;?xml version='1.0'?&gt;</span>
<span class="cp">&lt;!DOCTYPE platform SYSTEM "http://simgrid.gforge.inria.fr/simgrid/simgrid.dtd"&gt;</span>
<span class="nt">&lt;platform</span> <span class="na">version=</span><span class="s">"4.1"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;zone</span> <span class="na">id=</span><span class="s">"AS0"</span> <span class="na">routing=</span><span class="s">"Full"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;cluster</span> <span class="na">id=</span><span class="s">"my_cluster_1"</span> <span class="na">prefix=</span><span class="s">"C1−"</span> <span class="na">suffix=</span><span class="s">".hawaii.edu"</span> <span class="na">radical=</span><span class="s">"0−15"</span> <span class="na">speed=</span><span class="s">"1Gf"</span> <span class="na">bw=</span><span class="s">"125Mbps"</span> <span class="na">lat=</span><span class="s">"50us"</span> <span class="na">bb_bw=</span><span class="s">"2.25Gbps"</span> <span class="na">bb_lat=</span><span class="s">"500us"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;cluster</span> <span class="na">id=</span><span class="s">"my_cluster_2"</span> <span class="na">prefix=</span><span class="s">"C2−"</span> <span class="na">suffix=</span><span class="s">".hawaii.edu"</span> <span class="na">radical=</span><span class="s">"0−31"</span> <span class="na">speed=</span><span class="s">"2Gf"</span> <span class="na">bw=</span><span class="s">"125Mbps"</span> <span class="na">lat=</span><span class="s">"50us"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">id=</span><span class="s">"internet_backbone"</span> <span class="na">bandwidth=</span><span class="s">"0.01Gbps"</span> <span class="na">latency=</span><span class="s">"22500us"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;zoneRoute</span> <span class="na">src=</span><span class="s">"my_cluster_1"</span> <span class="na">dst=</span><span class="s">"my_cluster_2"</span> <span class="na">gw_src=</span><span class="s">"C1−my_cluster_1_router.hawaii.edu"</span> <span class="na">gw_dst=</span><span class="s">"C2−my_cluster_2_router.hawaii.edu"</span> <span class="na">symmetrical=</span><span class="s">"YES"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;link_ctn</span> <span class="na">id=</span><span class="s">"internet_backbone"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/zoneRoute&gt;</span>
  <span class="nt">&lt;/zone&gt;</span>
<span class="nt">&lt;/platform&gt;</span>

    </code></pre></figure>

    </div>
  </div>
</div>

<p class="ui">
  The above XML is a bit more involved. See all details and documentation on the
  <a href="http://simgrid.gforge.inria.fr">SimGrid Web site</a>.

</p>

<div class="ui divider"></div>


</div>

<div class="ui tab segment" data-tab="third">
  <p class="ui">
We are now ready to simulate the execution of an MPI program using SMPI. Let us use the following simple
  MPI program,
  <a href="../topic_getting_started/roundtrip.c"><code>roundtrip.c</code></a>, in which the processes pass around a message and
  print the elpased time:
  </p>


<div class="ui accordion">
  <div class=" title">
    <i class="dropdown icon"></i>
    See the code of <a href="../topic_getting_started/roundtrip.c"><code>roundtrip.c</code></a>...
  </div>
  <div class=" content">
    <div class="ui container segment">
      
<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;mpi.h&gt;
</span>
<span class="cp">#define N (1024 * 1024 * 1)
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">rank</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">timeval</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">hostname</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">hostname_len</span><span class="p">;</span>

  <span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>
  <span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
  <span class="n">MPI_Get_processor_name</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hostname_len</span><span class="p">);</span>

  <span class="c1">// Allocate a 10MiB buffer</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">N</span><span class="p">);</span>


  <span class="c1">// Communicate along the ring</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Rank %d (running on '%s'): sending the message rank %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">hostname</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">MPI_Send</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">MPI_BYTE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
       	<span class="n">MPI_Recv</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">MPI_BYTE</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Rank %d (running on '%s'): received the message from rank %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">hostname</span><span class="p">,</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  	<span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
  	<span class="n">printf</span><span class="p">(</span><span class="s">"%f</span><span class="se">\n</span><span class="s">"</span><span class="p">,(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">*</span><span class="mi">1000000</span><span class="p">.</span><span class="mi">0</span> <span class="o">+</span> <span class="n">end</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span>
		 	<span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">*</span><span class="mi">1000000</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       	<span class="n">MPI_Recv</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">MPI_BYTE</span><span class="p">,</span> <span class="n">rank</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Rank %d (running on '%s'): receive the message and sending it to rank %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">hostname</span><span class="p">,(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">size</span><span class="p">);</span>
	<span class="n">MPI_Send</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">MPI_BYTE</span><span class="p">,</span> <span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">MPI_Finalize</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

  </code></pre></figure>

    </div>
  </div>
</div>


<p class="ui">
  Say we want to simulate the execution of this program on a homogeneous cluster, such as the one we saw
  in the "XML Platforms" tab: <a href="../topic_getting_started/cluster_crossbar.xml">cluster_crossbar.xml</a>.
  We need an "MPI host file", that is a simple text file that lists all hosts on which we wish to
  start an MPI process: <a href="../topic_getting_started/cluster_hostfile.txt">cluster_hostfile.txt</a>.
</p>

<p class="ui">Compiling the program is straightforward:</p>
<div class="ui segment raised">

<figure class="highlight"><pre><code class="language-text" data-lang="text">  % smpicc -O4 roundtrip.c -o roundtrip</code></pre></figure>

</div>

<p class="ui">Running (simulating) it using 16 hosts on the cluster is done as follows:</p>

<div class="ui segment raised">

<figure class="highlight"><pre><code class="language-text" data-lang="text">  % smpirun -np 16 -hostfile ./cluster_hostfile.txt -platform ./cluster_crossbar.xml ./roundtrip</code></pre></figure>

</div>

<div class="ui list bulleted">

<div class="ui item">The <code>-np 16</code> option, just like in regular MPI, specifies the number of MPI processes to use. </div>
<div class="ui item">The <code>-hostfile ./cluster_hostfile.txt</code> option, just like in regular MPI, specifies the host file. </div>
<div class="ui item">The <code>-platform ./cluster_crossbar.xml</code> option, <b>which doesn't exist in regular MPI</b>, specifies the platform configuration to be simulated. </div>
<div class="ui item">At the end of the command, one finds the executable name and command-line arguments (in this case there are none).</div>

</div>


<p class="ui">
You will see some warnings/information regarding setting some SMPI configuration parameters. Ignore them for now. One of them will say something about not setting the power of the host running the simulation. This is fine here because in this small example we wish only to simulate the network. 
</p>

<p class="ui">
  Feel free to tweak the content of the XML platform file and the program to see the effect on the simulated execution time.  Note that
  the simulation accounts for realistic network protocol effects and MPI implementation effects. As a result, you may see
  "unexpected behavior" like in the real world (e.g., sending a message 1 byte larger may lead to significant higher
  execution time).
</p>


</div>

<div class="ui tab segment" data-tab="fourth">
  <p class="ui">
  SMPI is robust, but it still has some limitations, as listed (and further explained) below:
</p>


<div class="ui accordion">

  <div class="ui container segment">

    <div class=" title">
      <h4 class="header"><i class="dropdown icon"></i> Do not use global variables that should be distinct across MPI
        processes</h4>
    </div>
    <div class=" content">
      SMPI runs your MPI processes as threads within a single process. So when you declare a global variable in your
      program
      (which is rarely a good idea anyway), all the threads will share it, as threads do. That's likely not what you
      want
      in terms of your MPI processes. Use local variables instead.
    </div>
  </div>

  <div class="ui container segment">

    <div class=" title">
      <h4 class="header">
        <i class="dropdown icon"></i>
        Do not use multithreading in your program
      </h4>
    </div>
    <div class=" content">
      Because SMPI already uses multithreading to simulate your MPI program's execution, if your MPI program uses
      threads
      as well, mayhem can occur. In practice, i.e., with real MPI, you typically want to use threads to exploit
      multi-core
      machines. In these pedagogic modules, simply pretend that each host is single-core and that you don't need to use
      threads.
      This has no impact on your learning MPI, and if/when you transition to real (as opposed to simulated) MPI
      executions, you
      can then simply multi-thread computational sections of your code.
    </div>
  </div>

  <div class="ui container segment">

    <div class=" title">
      <h4 class="header">
        <i class="dropdown icon"></i>
        Don't make your C code weird
      </h4>
    </div>
    <div class=" content">
      Yes, this is vague. <code>smpicc</code> compiles your code, and is fairly robust. But if you go crazy with
      tons of macros and C oddness, <code>smpicc</code> may get confused. It should happen only in rather extreme
      cases, but you are now warned.
    </div>
  </div>

</div>

</div>



  <br>

</div>
	</div>



</body>
</html>
